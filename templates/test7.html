<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ãƒã‚±ãƒƒãƒˆåˆ¤åˆ¥APIãƒ»å®Œæˆç‰ˆ</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; max-width: 720px; margin: 24px auto; line-height: 1.7; }
    .group { padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin: 12px 0; }
    button { padding: 8px 12px; cursor: pointer; }
    .result { padding: 12px; border: 1px solid #ccc; border-radius: 8px; background: #fafafa; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; }
    thead th { background: #e0e0e0; }
  </style>
</head>
<body>
  <form class="container">
    <h1>ãƒã‚±ãƒƒãƒˆåˆ¤åˆ¥APIãƒ»å®Œæˆç‰ˆ</h1>

    <div class="group">
      <p>å¹´é½¢</p>
      <input type="number" id="age" placeholder="ä¾‹: 20" min="0">
    </div>

    <div class="group">
      <p>å­¦ç”Ÿã§ã™ã‹ï¼Ÿ</p>
      <label><input type="radio" name="student" value="true">ã¯ã„</label>
      <label><input type="radio" name="student" value="false">ã„ã„ãˆ</label>
    </div>

    <div class="group">
      <p>ç¥æ—¥ã§ã™ã‹ï¼Ÿ</p>
      <label><input type="radio" name="holiday" value="true">ã¯ã„</label>
      <label><input type="radio" name="holiday" value="false">ã„ã„ãˆ</label>
    </div>

    <div class="group">
      <p>å±…ä½åŒº</p>
      <label><input type="radio" name="resident" value="local">åœ°å…ƒ</label>
      <label><input type="radio" name="resident" value="other">åœ°å…ƒä»¥å¤–</label>
    </div>

    <div class="group">
      <p>ä¼šå“¡ãƒ©ãƒ³ã‚¯</p>
      <select id="member">
        <option value="none">éä¼šå“¡ï¼ˆå‰²å¼•ãªã—ï¼‰</option>
        <option value="silver">ã‚·ãƒ«ãƒãƒ¼ï¼ˆ-100å††ï¼‰</option>
        <option value="gold">ã‚´ãƒ¼ãƒ«ãƒ‰ï¼ˆ-200å††ï¼‰</option>
      </select>
    </div>

    <div class="group">
      <p>æ™‚é–“å¸¯</p>
      <select id="timeband">
        <option value="morning">åˆå‰ï¼ˆ-200å††ï¼‰</option>
        <option value="afternoon">æ˜¼ï¼ˆÂ±0å††ï¼‰</option>
        <option value="night">å¤œï¼ˆ+100å††ï¼‰</option>
      </select>
    </div>

    <div class="group">
      <p>ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰</p>
      <input id="coupon" type="text" placeholder="ä¾‹: ABC1234">
    </div>

    <button id="send" type="button">é€ä¿¡</button>

    <!-- çµæœã‚«ãƒ¼ãƒ‰ã®ç½®ãå ´ï¼ˆdivã«ã—ã¦ãŠãï¼‰ -->
    <div id="result" class="result" style="margin-top:12px;">ã“ã¡ã‚‰ã«çµæœã‚’è¡¨ç¤º</div>

    <h2>å±¥æ­´</h2>
    <button id="clear" type="button">å±¥æ­´ã‚¯ãƒªã‚¢</button>
    <div id="history" style="margin-top:8px;"></div>
  </form>

  <script>
    // è¦ç´ ã®å–å¾—
    const ageEl      = document.getElementById("age");
    const memberEl   = document.getElementById("member");
    const timebandEl = document.getElementById("timeband");
    const couponEl   = document.getElementById("coupon");
    const resultBox  = document.getElementById("result");
    const historyBox = document.getElementById("history");
    const sendBtn    = document.getElementById("send");
    const clearBtn   = document.getElementById("clear");

    // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ï¼ˆé…åˆ—ï¼‰
    const history = [];

    // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»ã™ã‚‹é–¢æ•°ï¼ˆhistory â†’ HTMLï¼‰
    function renderHistory(list) {
      if (!list || list.length === 0) {
        historyBox.innerHTML = "<p>ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
      }

      const rows = list.map((h, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${h.category}</td>
          <td>${h.base}</td>
          <td style="color:${h.time < 0 ? 'green' : (h.time > 0 ? 'red' : 'black')}">
            ${h.time >= 0 ? '+' : ''}${h.time}
          </td>
          <td style="color:${h.member < 0 ? 'green' : (h.member > 0 ? 'red' : 'black')}">
            ${h.member >= 0 ? '+' : ''}${h.member}
          </td>
          <td><strong>${h.total}</strong></td>
          <td class="mono">${h.ts ?? ""}</td>
        </tr>
      `).join("");

      historyBox.innerHTML = `
        <h3>é€ä¿¡å±¥æ­´</h3>
        <table>
          <thead>
            <tr>
              <th>No</th>
              <th>ã‚«ãƒ†ã‚´ãƒª</th>
              <th>åŸºæœ¬</th>
              <th>æ™‚é–“å¸¯</th>
              <th>ä¼šå“¡</th>
              <th>åˆè¨ˆ</th>
              <th>æ™‚åˆ»</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    // é€ä¿¡ãƒœã‚¿ãƒ³
    sendBtn.addEventListener("click", async () => {
      const age = ageEl.valueAsNumber;
      const sEl = document.querySelector('input[name="student"]:checked');
      const hEl = document.querySelector('input[name="holiday"]:checked');
      const rEl = document.querySelector('input[name="resident"]:checked');

      if (!Number.isFinite(age) || !sEl || !hEl || !rEl) {
        resultBox.textContent = "å¹´é½¢ã¨å„é …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›ãƒ»é¸æŠã—ã¦ãã ã•ã„ã€‚";
        return;
      }

      const student = (sEl.value === "true");
      const holiday = (hEl.value === "true");
      const resident = rEl.value;
      const member = memberEl.value;
      const timeband = timebandEl.value;
      const coupon = couponEl.value.trim();

      const payload = { age, student, holiday, resident, member, timeband, coupon };

      try {
        const res = await fetch("/api/ticket", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();

        if (!data.ok) {
          resultBox.textContent = data.message || "ã‚µãƒ¼ãƒãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
          return;
        }

        // æœ€æ–°çµæœã‚«ãƒ¼ãƒ‰ï¼ˆ#result ã«ä¸Šæ›¸ãï¼‰
        resultBox.innerHTML = `
          <div style="border:1px solid #ddd; border-radius:8px; padding:16px; background:#fafafa; margin-bottom:20px;">
            <h3 style="margin-top:0;">ğŸŸï¸ ãƒã‚±ãƒƒãƒˆçµæœ</h3>
            <p>ã‚«ãƒ†ã‚´ãƒªï¼š<strong>${data.category_label}</strong>${data.category_key ? `ï¼ˆ${data.category_key}ï¼‰` : ""}</p>
            <p>åŸºæœ¬æ–™é‡‘ï¼š<strong>${data.base_price}å††</strong></p>
            <p>æ™‚é–“å¸¯èª¿æ•´ï¼š${data.timeband_adj >= 0 ? '+' : ''}${data.timeband_adj}å††</p>
            <p>ä¼šå“¡èª¿æ•´ï¼š${data.member_adj >= 0 ? '+' : ''}${data.member_adj}å††</p>
            <hr>
            <p style="font-size:1.1em;">åˆè¨ˆé‡‘é¡ï¼š<strong>${data.price}å††</strong></p>
          </div>
        `;

        // å±¥æ­´ã«1ä»¶è¿½åŠ ã—ã¦å†æç”»
        history.push({
          category: data.category_label,
          base:     data.base_price,
          time:     data.timeband_adj,
          member:   data.member_adj,
          total:    data.price,
          ts:       new Date().toLocaleString()
        });
        renderHistory(history);

      } catch (e) {
        resultBox.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
        console.error(e);
      }
    });

    // å±¥æ­´ã‚¯ãƒªã‚¢
    clearBtn.addEventListener("click", () => {
      history.length = 0;      // ä¸­èº«ã‚’ç©ºã«ã™ã‚‹
      renderHistory(history);  // ç©ºã®çŠ¶æ…‹ã‚’è¡¨ç¤º
    });
  </script>
</body>
</html>